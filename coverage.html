
<!DOCTYPE html>
<html>
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
		<title>repository: Go Coverage Report</title>
		<style>
			body {
				background: black;
				color: rgb(80, 80, 80);
			}
			body, pre, #legend span {
				font-family: Menlo, monospace;
				font-weight: bold;
			}
			#topbar {
				background: black;
				position: fixed;
				top: 0; left: 0; right: 0;
				height: 42px;
				border-bottom: 1px solid rgb(80, 80, 80);
			}
			#content {
				margin-top: 50px;
			}
			#nav, #legend {
				float: left;
				margin-left: 10px;
			}
			#legend {
				margin-top: 12px;
			}
			#nav {
				margin-top: 10px;
			}
			#legend span {
				margin: 0 5px;
			}
			.cov0 { color: rgb(192, 0, 0) }
.cov1 { color: rgb(128, 128, 128) }
.cov2 { color: rgb(116, 140, 131) }
.cov3 { color: rgb(104, 152, 134) }
.cov4 { color: rgb(92, 164, 137) }
.cov5 { color: rgb(80, 176, 140) }
.cov6 { color: rgb(68, 188, 143) }
.cov7 { color: rgb(56, 200, 146) }
.cov8 { color: rgb(44, 212, 149) }
.cov9 { color: rgb(32, 224, 152) }
.cov10 { color: rgb(20, 236, 155) }

		</style>
	</head>
	<body>
		<div id="topbar">
			<div id="nav">
				<select id="files">
				
				<option value="file0">github.com/Notifuse/notifuse/internal/repository/auth_repository.go (100.0%)</option>
				
				<option value="file1">github.com/Notifuse/notifuse/internal/repository/contact_list_postgres.go (83.3%)</option>
				
				<option value="file2">github.com/Notifuse/notifuse/internal/repository/contact_postgres.go (77.9%)</option>
				
				<option value="file3">github.com/Notifuse/notifuse/internal/repository/list_postgres.go (86.6%)</option>
				
				<option value="file4">github.com/Notifuse/notifuse/internal/repository/testutil/db.go (100.0%)</option>
				
				<option value="file5">github.com/Notifuse/notifuse/internal/repository/testutil/mock_workspace.go (23.8%)</option>
				
				<option value="file6">github.com/Notifuse/notifuse/internal/repository/user_postgres.go (86.1%)</option>
				
				<option value="file7">github.com/Notifuse/notifuse/internal/repository/workspace_postgres.go (80.9%)</option>
				
				</select>
			</div>
			<div id="legend">
				<span>not tracked</span>
			
				<span class="cov0">not covered</span>
				<span class="cov8">covered</span>
			
			</div>
		</div>
		<div id="content">
		
		<pre class="file" id="file0" style="display: none">package repository

import (
        "context"
        "database/sql"
        "time"

        "github.com/Notifuse/notifuse/internal/domain"
        "github.com/Notifuse/notifuse/pkg/logger"
)

// SQLAuthRepository is a SQL implementation of the AuthRepository interface
type SQLAuthRepository struct {
        db     *sql.DB
        logger logger.Logger
}

// NewSQLAuthRepository creates a new SQLAuthRepository
func NewSQLAuthRepository(db *sql.DB, logger logger.Logger) *SQLAuthRepository <span class="cov8" title="1">{
        return &amp;SQLAuthRepository{
                db:     db,
                logger: logger,
        }
}</span>

// GetSessionByID retrieves a session by ID and user ID
func (r *SQLAuthRepository) GetSessionByID(ctx context.Context, sessionID string, userID string) (*time.Time, error) <span class="cov8" title="1">{
        var expiresAt time.Time
        err := r.db.QueryRowContext(ctx,
                "SELECT expires_at FROM user_sessions WHERE id = $1 AND user_id = $2",
                sessionID, userID,
        ).Scan(&amp;expiresAt)

        if err != nil </span><span class="cov8" title="1">{
                return nil, err
        }</span>

        <span class="cov8" title="1">return &amp;expiresAt, nil</span>
}

// GetUserByID retrieves a user by ID
func (r *SQLAuthRepository) GetUserByID(ctx context.Context, userID string) (*domain.User, error) <span class="cov8" title="1">{
        var user domain.User
        err := r.db.QueryRowContext(ctx,
                "SELECT id, email, created_at FROM users WHERE id = $1",
                userID,
        ).Scan(&amp;user.ID, &amp;user.Email, &amp;user.CreatedAt)

        if err != nil </span><span class="cov8" title="1">{
                return nil, err
        }</span>

        <span class="cov8" title="1">return &amp;user, nil</span>
}
</pre>
		
		<pre class="file" id="file1" style="display: none">package repository

import (
        "context"
        "database/sql"
        "fmt"
        "time"

        "github.com/Notifuse/notifuse/internal/domain"
)

type contactListRepository struct {
        workspaceRepo domain.WorkspaceRepository
}

// NewContactListRepository creates a new PostgreSQL contact list repository
func NewContactListRepository(workspaceRepo domain.WorkspaceRepository) domain.ContactListRepository <span class="cov8" title="1">{
        return &amp;contactListRepository{
                workspaceRepo: workspaceRepo,
        }
}</span>

func (r *contactListRepository) AddContactToList(ctx context.Context, workspaceID string, contactList *domain.ContactList) error <span class="cov8" title="1">{

        // Get the workspace database connection
        workspaceDB, err := r.workspaceRepo.GetConnection(ctx, workspaceID)
        if err != nil </span><span class="cov8" title="1">{
                return fmt.Errorf("failed to get workspace connection: %w", err)
        }</span>

        <span class="cov8" title="1">now := time.Now().UTC()
        contactList.CreatedAt = now
        contactList.UpdatedAt = now

        query := `
                INSERT INTO contact_lists (email, list_id, status, created_at, updated_at)
                VALUES ($1, $2, $3, $4, $5)
                ON CONFLICT (email, list_id) DO UPDATE
                SET status = $3, updated_at = $5
        `
        _, err = workspaceDB.ExecContext(ctx, query,
                contactList.Email,
                contactList.ListID,
                contactList.Status,
                contactList.CreatedAt,
                contactList.UpdatedAt,
        )
        if err != nil </span><span class="cov8" title="1">{
                return fmt.Errorf("failed to add contact to list: %w", err)
        }</span>
        <span class="cov8" title="1">return nil</span>
}

func (r *contactListRepository) GetContactListByIDs(ctx context.Context, workspaceID string, email, listID string) (*domain.ContactList, error) <span class="cov8" title="1">{

        // Get the workspace database connection
        workspaceDB, err := r.workspaceRepo.GetConnection(ctx, workspaceID)
        if err != nil </span><span class="cov0" title="0">{
                return nil, fmt.Errorf("failed to get workspace connection: %w", err)
        }</span>

        <span class="cov8" title="1">query := `
                SELECT email, list_id, status, created_at, updated_at
                FROM contact_lists
                WHERE email = $1 AND list_id = $2
        `

        row := workspaceDB.QueryRowContext(ctx, query, email, listID)
        contactList, err := domain.ScanContactList(row)

        if err == sql.ErrNoRows </span><span class="cov8" title="1">{
                return nil, &amp;domain.ErrContactListNotFound{Message: "contact list not found"}
        }</span>
        <span class="cov8" title="1">if err != nil </span><span class="cov0" title="0">{
                return nil, fmt.Errorf("failed to get contact list: %w", err)
        }</span>

        <span class="cov8" title="1">return contactList, nil</span>
}

func (r *contactListRepository) GetContactsByListID(ctx context.Context, workspaceID string, listID string) ([]*domain.ContactList, error) <span class="cov8" title="1">{

        // Get the workspace database connection
        workspaceDB, err := r.workspaceRepo.GetConnection(ctx, workspaceID)
        if err != nil </span><span class="cov0" title="0">{
                return nil, fmt.Errorf("failed to get workspace connection: %w", err)
        }</span>

        <span class="cov8" title="1">query := `
                SELECT email, list_id, status, created_at, updated_at
                FROM contact_lists
                WHERE list_id = $1
                ORDER BY created_at DESC
        `

        rows, err := workspaceDB.QueryContext(ctx, query, listID)
        if err != nil </span><span class="cov8" title="1">{
                return nil, fmt.Errorf("failed to get contacts for list: %w", err)
        }</span>
        <span class="cov8" title="1">defer rows.Close()

        var contactLists []*domain.ContactList
        for rows.Next() </span><span class="cov8" title="1">{
                contactList, err := domain.ScanContactList(rows)
                if err != nil </span><span class="cov0" title="0">{
                        return nil, fmt.Errorf("failed to scan contact list: %w", err)
                }</span>
                <span class="cov8" title="1">contactLists = append(contactLists, contactList)</span>
        }

        <span class="cov8" title="1">if err := rows.Err(); err != nil </span><span class="cov0" title="0">{
                return nil, fmt.Errorf("error iterating contact list rows: %w", err)
        }</span>

        <span class="cov8" title="1">return contactLists, nil</span>
}

func (r *contactListRepository) GetListsByEmail(ctx context.Context, workspaceID string, email string) ([]*domain.ContactList, error) <span class="cov8" title="1">{

        // Get the workspace database connection
        workspaceDB, err := r.workspaceRepo.GetConnection(ctx, workspaceID)
        if err != nil </span><span class="cov0" title="0">{
                return nil, fmt.Errorf("failed to get workspace connection: %w", err)
        }</span>

        <span class="cov8" title="1">query := `
                SELECT email, list_id, status, created_at, updated_at
                FROM contact_lists
                WHERE email = $1
                ORDER BY created_at DESC
        `

        rows, err := workspaceDB.QueryContext(ctx, query, email)
        if err != nil </span><span class="cov8" title="1">{
                return nil, fmt.Errorf("failed to get lists for contact: %w", err)
        }</span>
        <span class="cov8" title="1">defer rows.Close()

        var contactLists []*domain.ContactList
        for rows.Next() </span><span class="cov8" title="1">{
                contactList, err := domain.ScanContactList(rows)
                if err != nil </span><span class="cov0" title="0">{
                        return nil, fmt.Errorf("failed to scan contact list: %w", err)
                }</span>
                <span class="cov8" title="1">contactLists = append(contactLists, contactList)</span>
        }

        <span class="cov8" title="1">if err := rows.Err(); err != nil </span><span class="cov0" title="0">{
                return nil, fmt.Errorf("error iterating contact list rows: %w", err)
        }</span>

        <span class="cov8" title="1">return contactLists, nil</span>
}

func (r *contactListRepository) UpdateContactListStatus(ctx context.Context, workspaceID string, email, listID string, status domain.ContactListStatus) error <span class="cov8" title="1">{

        // Get the workspace database connection
        workspaceDB, err := r.workspaceRepo.GetConnection(ctx, workspaceID)
        if err != nil </span><span class="cov0" title="0">{
                return fmt.Errorf("failed to get workspace connection: %w", err)
        }</span>

        <span class="cov8" title="1">now := time.Now().UTC()

        query := `
                UPDATE contact_lists
                SET status = $1, updated_at = $2
                WHERE email = $3 AND list_id = $4
        `

        result, err := workspaceDB.ExecContext(ctx, query,
                status,
                now,
                email,
                listID,
        )

        if err != nil </span><span class="cov0" title="0">{
                return fmt.Errorf("failed to update contact list status: %w", err)
        }</span>

        <span class="cov8" title="1">rows, err := result.RowsAffected()
        if err != nil </span><span class="cov0" title="0">{
                return fmt.Errorf("failed to get affected rows: %w", err)
        }</span>

        <span class="cov8" title="1">if rows == 0 </span><span class="cov8" title="1">{
                return &amp;domain.ErrContactListNotFound{Message: "contact list not found"}
        }</span>

        <span class="cov8" title="1">return nil</span>
}

func (r *contactListRepository) RemoveContactFromList(ctx context.Context, workspaceID string, email, listID string) error <span class="cov8" title="1">{

        // Get the workspace database connection
        workspaceDB, err := r.workspaceRepo.GetConnection(ctx, workspaceID)
        if err != nil </span><span class="cov0" title="0">{
                return fmt.Errorf("failed to get workspace connection: %w", err)
        }</span>

        <span class="cov8" title="1">query := `DELETE FROM contact_lists WHERE email = $1 AND list_id = $2`

        result, err := workspaceDB.ExecContext(ctx, query, email, listID)
        if err != nil </span><span class="cov0" title="0">{
                return fmt.Errorf("failed to remove contact from list: %w", err)
        }</span>

        <span class="cov8" title="1">rows, err := result.RowsAffected()
        if err != nil </span><span class="cov0" title="0">{
                return fmt.Errorf("failed to get affected rows: %w", err)
        }</span>

        <span class="cov8" title="1">if rows == 0 </span><span class="cov8" title="1">{
                return &amp;domain.ErrContactListNotFound{Message: "contact list not found"}
        }</span>

        <span class="cov8" title="1">return nil</span>
}
</pre>
		
		<pre class="file" id="file2" style="display: none">package repository

import (
        "context"
        "database/sql"
        "encoding/json"
        "fmt"
        "strings"
        "time"

        "github.com/Notifuse/notifuse/internal/domain"
)

type contactRepository struct {
        workspaceRepo domain.WorkspaceRepository
}

// NewContactRepository creates a new PostgreSQL contact repository
func NewContactRepository(workspaceRepo domain.WorkspaceRepository) domain.ContactRepository <span class="cov8" title="1">{
        return &amp;contactRepository{
                workspaceRepo: workspaceRepo,
        }
}</span>

func (r *contactRepository) GetContactByEmail(ctx context.Context, email string, workspaceID string) (*domain.Contact, error) <span class="cov8" title="1">{
        // Get the workspace database connection
        workspaceDB, err := r.workspaceRepo.GetConnection(ctx, workspaceID)
        if err != nil </span><span class="cov0" title="0">{
                return nil, fmt.Errorf("failed to get workspace connection: %w", err)
        }</span>

        <span class="cov8" title="1">query := `
                SELECT 
                        email, external_id, timezone, language,
                        first_name, last_name, phone, address_line_1, address_line_2,
                        country, postcode, state, job_title,
                        lifetime_value, orders_count, last_order_at,
                        custom_string_1, custom_string_2, custom_string_3, custom_string_4, custom_string_5,
                        custom_number_1, custom_number_2, custom_number_3, custom_number_4, custom_number_5,
                        custom_datetime_1, custom_datetime_2, custom_datetime_3, custom_datetime_4, custom_datetime_5,
                        custom_json_1, custom_json_2, custom_json_3, custom_json_4, custom_json_5,
                        created_at, updated_at
                FROM contacts
                WHERE email = $1
        `

        row := workspaceDB.QueryRowContext(ctx, query, email)
        contact, err := domain.ScanContact(row)

        if err == sql.ErrNoRows </span><span class="cov8" title="1">{
                return nil, &amp;domain.ErrContactNotFound{Message: "contact not found"}
        }</span>
        <span class="cov8" title="1">if err != nil </span><span class="cov8" title="1">{
                return nil, fmt.Errorf("failed to get contact: %w", err)
        }</span>

        <span class="cov8" title="1">return contact, nil</span>
}

func (r *contactRepository) GetContactByExternalID(ctx context.Context, externalID string, workspaceID string) (*domain.Contact, error) <span class="cov8" title="1">{
        // Get the workspace database connection
        workspaceDB, err := r.workspaceRepo.GetConnection(ctx, workspaceID)
        if err != nil </span><span class="cov0" title="0">{
                return nil, fmt.Errorf("failed to get workspace connection: %w", err)
        }</span>

        <span class="cov8" title="1">query := `
                SELECT 
                        email, external_id, timezone, language,
                        first_name, last_name, phone, address_line_1, address_line_2,
                        country, postcode, state, job_title,
                        lifetime_value, orders_count, last_order_at,
                        custom_string_1, custom_string_2, custom_string_3, custom_string_4, custom_string_5,
                        custom_number_1, custom_number_2, custom_number_3, custom_number_4, custom_number_5,
                        custom_datetime_1, custom_datetime_2, custom_datetime_3, custom_datetime_4, custom_datetime_5,
                        custom_json_1, custom_json_2, custom_json_3, custom_json_4, custom_json_5,
                        created_at, updated_at
                FROM contacts
                WHERE external_id = $1
        `

        row := workspaceDB.QueryRowContext(ctx, query, externalID)
        contact, err := domain.ScanContact(row)

        if err == sql.ErrNoRows </span><span class="cov8" title="1">{
                return nil, &amp;domain.ErrContactNotFound{Message: "contact not found"}
        }</span>
        <span class="cov8" title="1">if err != nil </span><span class="cov0" title="0">{
                return nil, fmt.Errorf("failed to get contact: %w", err)
        }</span>

        <span class="cov8" title="1">return contact, nil</span>
}

func (r *contactRepository) GetContacts(ctx context.Context, req *domain.GetContactsRequest) (*domain.GetContactsResponse, error) <span class="cov8" title="1">{
        // Get the workspace database connection
        workspaceDB, err := r.workspaceRepo.GetConnection(ctx, req.WorkspaceID)
        if err != nil </span><span class="cov8" title="1">{
                return nil, fmt.Errorf("failed to get workspace connection: %w", err)
        }</span>

        // Build the base query
        <span class="cov8" title="1">baseQuery := `
                SELECT 
                        email, external_id, timezone, language,
                        first_name, last_name, phone, address_line_1, address_line_2,
                        country, postcode, state, job_title,
                        lifetime_value, orders_count, last_order_at,
                        custom_string_1, custom_string_2, custom_string_3, custom_string_4, custom_string_5,
                        custom_number_1, custom_number_2, custom_number_3, custom_number_4, custom_number_5,
                        custom_datetime_1, custom_datetime_2, custom_datetime_3, custom_datetime_4, custom_datetime_5,
                        custom_json_1, custom_json_2, custom_json_3, custom_json_4, custom_json_5,
                        created_at, updated_at
                FROM contacts
        `

        // Build the WHERE clause for filters
        var conditions []string
        var args []interface{}
        argIndex := 1

        if req.Email != "" </span><span class="cov8" title="1">{
                conditions = append(conditions, fmt.Sprintf("email ILIKE $%d", argIndex))
                args = append(args, "%"+req.Email+"%")
                argIndex++
        }</span>

        <span class="cov8" title="1">if req.ExternalID != "" </span><span class="cov0" title="0">{
                conditions = append(conditions, fmt.Sprintf("external_id ILIKE $%d", argIndex))
                args = append(args, "%"+req.ExternalID+"%")
                argIndex++
        }</span>

        <span class="cov8" title="1">if req.FirstName != "" </span><span class="cov8" title="1">{
                conditions = append(conditions, fmt.Sprintf("first_name ILIKE $%d", argIndex))
                args = append(args, "%"+req.FirstName+"%")
                argIndex++
        }</span>

        <span class="cov8" title="1">if req.LastName != "" </span><span class="cov0" title="0">{
                conditions = append(conditions, fmt.Sprintf("last_name ILIKE $%d", argIndex))
                args = append(args, "%"+req.LastName+"%")
                argIndex++
        }</span>

        <span class="cov8" title="1">if req.Phone != "" </span><span class="cov0" title="0">{
                conditions = append(conditions, fmt.Sprintf("phone ILIKE $%d", argIndex))
                args = append(args, "%"+req.Phone+"%")
                argIndex++
        }</span>

        <span class="cov8" title="1">if req.Country != "" </span><span class="cov8" title="1">{
                conditions = append(conditions, fmt.Sprintf("country ILIKE $%d", argIndex))
                args = append(args, "%"+req.Country+"%")
                argIndex++
        }</span>

        // Add cursor condition if provided
        <span class="cov8" title="1">if req.Cursor != "" </span><span class="cov8" title="1">{
                // Parse the cursor timestamp
                cursorTime, err := time.Parse(time.RFC3339, req.Cursor)
                if err != nil </span><span class="cov8" title="1">{
                        return nil, fmt.Errorf("invalid cursor format: %w", err)
                }</span>
                <span class="cov8" title="1">conditions = append(conditions, fmt.Sprintf("created_at &lt; $%d", argIndex))
                args = append(args, cursorTime)
                argIndex++</span>
        }

        // Combine conditions
        <span class="cov8" title="1">if len(conditions) &gt; 0 </span><span class="cov8" title="1">{
                baseQuery += " WHERE " + strings.Join(conditions, " AND ")
        }</span>

        // Always order by created_at DESC for consistent pagination
        <span class="cov8" title="1">baseQuery += " ORDER BY created_at DESC"

        // Add LIMIT clause (get one extra to determine if there are more results)
        baseQuery += fmt.Sprintf(" LIMIT $%d", argIndex)
        args = append(args, req.Limit+1)

        // Execute the query
        rows, err := workspaceDB.QueryContext(ctx, baseQuery, args...)
        if err != nil </span><span class="cov0" title="0">{
                return nil, fmt.Errorf("failed to get contacts: %w", err)
        }</span>
        <span class="cov8" title="1">defer rows.Close()

        var contacts []*domain.Contact
        for rows.Next() </span><span class="cov8" title="1">{
                contact, err := domain.ScanContact(rows)
                if err != nil </span><span class="cov0" title="0">{
                        return nil, fmt.Errorf("failed to scan contact: %w", err)
                }</span>
                <span class="cov8" title="1">contacts = append(contacts, contact)</span>
        }

        <span class="cov8" title="1">if err := rows.Err(); err != nil </span><span class="cov0" title="0">{
                return nil, fmt.Errorf("error iterating contacts rows: %w", err)
        }</span>

        // Handle pagination
        <span class="cov8" title="1">var nextCursor string
        if len(contacts) &gt; req.Limit </span><span class="cov0" title="0">{
                // Remove the extra item we fetched
                contacts = contacts[:req.Limit]
                // Set the next cursor to the created_at of the last item
                nextCursor = contacts[len(contacts)-1].CreatedAt.Format(time.RFC3339)
        }</span>

        <span class="cov8" title="1">return &amp;domain.GetContactsResponse{
                Contacts:   contacts,
                NextCursor: nextCursor,
        }, nil</span>
}

func (r *contactRepository) DeleteContact(ctx context.Context, email string, workspaceID string) error <span class="cov8" title="1">{
        // Get the workspace database connection
        workspaceDB, err := r.workspaceRepo.GetConnection(ctx, workspaceID)
        if err != nil </span><span class="cov0" title="0">{
                return fmt.Errorf("failed to get workspace connection: %w", err)
        }</span>

        <span class="cov8" title="1">query := `DELETE FROM contacts WHERE email = $1`

        result, err := workspaceDB.ExecContext(ctx, query, email)
        if err != nil </span><span class="cov0" title="0">{
                return fmt.Errorf("failed to delete contact: %w", err)
        }</span>

        <span class="cov8" title="1">rows, err := result.RowsAffected()
        if err != nil </span><span class="cov0" title="0">{
                return fmt.Errorf("failed to get affected rows: %w", err)
        }</span>

        <span class="cov8" title="1">if rows == 0 </span><span class="cov8" title="1">{
                return &amp;domain.ErrContactNotFound{Message: "contact not found"}
        }</span>

        <span class="cov8" title="1">return nil</span>
}

func (r *contactRepository) BatchImportContacts(ctx context.Context, workspaceID string, contacts []*domain.Contact) error <span class="cov8" title="1">{
        // Get the workspace database connection
        workspaceDB, err := r.workspaceRepo.GetConnection(ctx, workspaceID)
        if err != nil </span><span class="cov0" title="0">{
                return fmt.Errorf("failed to get workspace connection: %w", err)
        }</span>

        // Prepare a transaction
        <span class="cov8" title="1">tx, err := workspaceDB.BeginTx(ctx, nil)
        if err != nil </span><span class="cov8" title="1">{
                return fmt.Errorf("failed to begin transaction: %w", err)
        }</span>
        <span class="cov8" title="1">defer tx.Rollback() // Rollback if there's a panic or error

        // Prepare a statement for contact insertion
        stmt, err := tx.PrepareContext(ctx, `
                INSERT INTO contacts (
                        email, external_id, timezone, language,
                        first_name, last_name, phone, address_line_1, address_line_2,
                        country, postcode, state, job_title,
                        lifetime_value, orders_count, last_order_at,
                        custom_string_1, custom_string_2, custom_string_3, custom_string_4, custom_string_5,
                        custom_number_1, custom_number_2, custom_number_3, custom_number_4, custom_number_5,
                        custom_datetime_1, custom_datetime_2, custom_datetime_3, custom_datetime_4, custom_datetime_5,
                        custom_json_1, custom_json_2, custom_json_3, custom_json_4, custom_json_5,
                        created_at, updated_at
                )
                VALUES (
                        $1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11, $12, $13, $14, $15, $16,
                        $17, $18, $19, $20, $21, $22, $23, $24, $25, $26, $27, $28, $29, $30, $31, $32,
                        $33, $34, $35, $36, $37, $38
                )
                ON CONFLICT (email) DO UPDATE SET
                        external_id = EXCLUDED.external_id,
                        timezone = EXCLUDED.timezone,
                        language = EXCLUDED.language,
                        first_name = EXCLUDED.first_name,
                        last_name = EXCLUDED.last_name,
                        phone = EXCLUDED.phone,
                        address_line_1 = EXCLUDED.address_line_1,
                        address_line_2 = EXCLUDED.address_line_2,
                        country = EXCLUDED.country,
                        postcode = EXCLUDED.postcode,
                        state = EXCLUDED.state,
                        job_title = EXCLUDED.job_title,
                        lifetime_value = EXCLUDED.lifetime_value,
                        orders_count = EXCLUDED.orders_count,
                        last_order_at = EXCLUDED.last_order_at,
                        custom_string_1 = EXCLUDED.custom_string_1,
                        custom_string_2 = EXCLUDED.custom_string_2,
                        custom_string_3 = EXCLUDED.custom_string_3,
                        custom_string_4 = EXCLUDED.custom_string_4,
                        custom_string_5 = EXCLUDED.custom_string_5,
                        custom_number_1 = EXCLUDED.custom_number_1,
                        custom_number_2 = EXCLUDED.custom_number_2,
                        custom_number_3 = EXCLUDED.custom_number_3,
                        custom_number_4 = EXCLUDED.custom_number_4,
                        custom_number_5 = EXCLUDED.custom_number_5,
                        custom_datetime_1 = EXCLUDED.custom_datetime_1,
                        custom_datetime_2 = EXCLUDED.custom_datetime_2,
                        custom_datetime_3 = EXCLUDED.custom_datetime_3,
                        custom_datetime_4 = EXCLUDED.custom_datetime_4,
                        custom_datetime_5 = EXCLUDED.custom_datetime_5,
                        custom_json_1 = EXCLUDED.custom_json_1,
                        custom_json_2 = EXCLUDED.custom_json_2,
                        custom_json_3 = EXCLUDED.custom_json_3,
                        custom_json_4 = EXCLUDED.custom_json_4,
                        custom_json_5 = EXCLUDED.custom_json_5,
                        updated_at = EXCLUDED.updated_at
        `)
        if err != nil </span><span class="cov8" title="1">{
                return fmt.Errorf("failed to prepare statement: %w", err)
        }</span>
        <span class="cov8" title="1">defer stmt.Close()

        // Execute in batches
        const batchSize = 100
        for i := 0; i &lt; len(contacts); i += batchSize </span><span class="cov8" title="1">{
                end := i + batchSize
                if end &gt; len(contacts) </span><span class="cov8" title="1">{
                        end = len(contacts)
                }</span>

                <span class="cov8" title="1">batch := contacts[i:end]
                for _, contact := range batch </span><span class="cov8" title="1">{
                        // Convert domain nullable types to SQL nullable types
                        var firstNameSQL, lastNameSQL, phoneSQL, addressLine1SQL, addressLine2SQL sql.NullString
                        var countrySQL, postcodeSQL, stateSQL, jobTitleSQL sql.NullString
                        var customString1SQL, customString2SQL, customString3SQL, customString4SQL, customString5SQL sql.NullString
                        var lifetimeValueSQL, ordersCountSQL sql.NullFloat64
                        var customNumber1SQL, customNumber2SQL, customNumber3SQL, customNumber4SQL, customNumber5SQL sql.NullFloat64
                        var lastOrderAtSQL, customDatetime1SQL, customDatetime2SQL, customDatetime3SQL, customDatetime4SQL, customDatetime5SQL sql.NullTime
                        var customJSON1SQL, customJSON2SQL, customJSON3SQL, customJSON4SQL, customJSON5SQL []byte

                        // String fields
                        if !contact.FirstName.IsNull </span><span class="cov8" title="1">{
                                firstNameSQL = sql.NullString{String: contact.FirstName.String, Valid: true}
                        }</span>
                        <span class="cov8" title="1">if !contact.LastName.IsNull </span><span class="cov8" title="1">{
                                lastNameSQL = sql.NullString{String: contact.LastName.String, Valid: true}
                        }</span>
                        <span class="cov8" title="1">if !contact.Phone.IsNull </span><span class="cov0" title="0">{
                                phoneSQL = sql.NullString{String: contact.Phone.String, Valid: true}
                        }</span>
                        <span class="cov8" title="1">if !contact.AddressLine1.IsNull </span><span class="cov0" title="0">{
                                addressLine1SQL = sql.NullString{String: contact.AddressLine1.String, Valid: true}
                        }</span>
                        <span class="cov8" title="1">if !contact.AddressLine2.IsNull </span><span class="cov0" title="0">{
                                addressLine2SQL = sql.NullString{String: contact.AddressLine2.String, Valid: true}
                        }</span>
                        <span class="cov8" title="1">if !contact.Country.IsNull </span><span class="cov0" title="0">{
                                countrySQL = sql.NullString{String: contact.Country.String, Valid: true}
                        }</span>
                        <span class="cov8" title="1">if !contact.Postcode.IsNull </span><span class="cov0" title="0">{
                                postcodeSQL = sql.NullString{String: contact.Postcode.String, Valid: true}
                        }</span>
                        <span class="cov8" title="1">if !contact.State.IsNull </span><span class="cov0" title="0">{
                                stateSQL = sql.NullString{String: contact.State.String, Valid: true}
                        }</span>
                        <span class="cov8" title="1">if !contact.JobTitle.IsNull </span><span class="cov0" title="0">{
                                jobTitleSQL = sql.NullString{String: contact.JobTitle.String, Valid: true}
                        }</span>

                        // Custom string fields
                        <span class="cov8" title="1">if !contact.CustomString1.IsNull </span><span class="cov0" title="0">{
                                customString1SQL = sql.NullString{String: contact.CustomString1.String, Valid: true}
                        }</span>
                        <span class="cov8" title="1">if !contact.CustomString2.IsNull </span><span class="cov0" title="0">{
                                customString2SQL = sql.NullString{String: contact.CustomString2.String, Valid: true}
                        }</span>
                        <span class="cov8" title="1">if !contact.CustomString3.IsNull </span><span class="cov0" title="0">{
                                customString3SQL = sql.NullString{String: contact.CustomString3.String, Valid: true}
                        }</span>
                        <span class="cov8" title="1">if !contact.CustomString4.IsNull </span><span class="cov0" title="0">{
                                customString4SQL = sql.NullString{String: contact.CustomString4.String, Valid: true}
                        }</span>
                        <span class="cov8" title="1">if !contact.CustomString5.IsNull </span><span class="cov0" title="0">{
                                customString5SQL = sql.NullString{String: contact.CustomString5.String, Valid: true}
                        }</span>

                        // Number fields
                        <span class="cov8" title="1">if !contact.LifetimeValue.IsNull </span><span class="cov0" title="0">{
                                lifetimeValueSQL = sql.NullFloat64{Float64: contact.LifetimeValue.Float64, Valid: true}
                        }</span>
                        <span class="cov8" title="1">if !contact.OrdersCount.IsNull </span><span class="cov0" title="0">{
                                ordersCountSQL = sql.NullFloat64{Float64: contact.OrdersCount.Float64, Valid: true}
                        }</span>

                        // Custom number fields
                        <span class="cov8" title="1">if !contact.CustomNumber1.IsNull </span><span class="cov0" title="0">{
                                customNumber1SQL = sql.NullFloat64{Float64: contact.CustomNumber1.Float64, Valid: true}
                        }</span>
                        <span class="cov8" title="1">if !contact.CustomNumber2.IsNull </span><span class="cov0" title="0">{
                                customNumber2SQL = sql.NullFloat64{Float64: contact.CustomNumber2.Float64, Valid: true}
                        }</span>
                        <span class="cov8" title="1">if !contact.CustomNumber3.IsNull </span><span class="cov0" title="0">{
                                customNumber3SQL = sql.NullFloat64{Float64: contact.CustomNumber3.Float64, Valid: true}
                        }</span>
                        <span class="cov8" title="1">if !contact.CustomNumber4.IsNull </span><span class="cov0" title="0">{
                                customNumber4SQL = sql.NullFloat64{Float64: contact.CustomNumber4.Float64, Valid: true}
                        }</span>
                        <span class="cov8" title="1">if !contact.CustomNumber5.IsNull </span><span class="cov0" title="0">{
                                customNumber5SQL = sql.NullFloat64{Float64: contact.CustomNumber5.Float64, Valid: true}
                        }</span>

                        // Datetime fields
                        <span class="cov8" title="1">if !contact.LastOrderAt.IsNull </span><span class="cov0" title="0">{
                                lastOrderAtSQL = sql.NullTime{Time: contact.LastOrderAt.Time, Valid: true}
                        }</span>

                        // Custom datetime fields
                        <span class="cov8" title="1">if !contact.CustomDatetime1.IsNull </span><span class="cov0" title="0">{
                                customDatetime1SQL = sql.NullTime{Time: contact.CustomDatetime1.Time, Valid: true}
                        }</span>
                        <span class="cov8" title="1">if !contact.CustomDatetime2.IsNull </span><span class="cov0" title="0">{
                                customDatetime2SQL = sql.NullTime{Time: contact.CustomDatetime2.Time, Valid: true}
                        }</span>
                        <span class="cov8" title="1">if !contact.CustomDatetime3.IsNull </span><span class="cov0" title="0">{
                                customDatetime3SQL = sql.NullTime{Time: contact.CustomDatetime3.Time, Valid: true}
                        }</span>
                        <span class="cov8" title="1">if !contact.CustomDatetime4.IsNull </span><span class="cov0" title="0">{
                                customDatetime4SQL = sql.NullTime{Time: contact.CustomDatetime4.Time, Valid: true}
                        }</span>
                        <span class="cov8" title="1">if !contact.CustomDatetime5.IsNull </span><span class="cov0" title="0">{
                                customDatetime5SQL = sql.NullTime{Time: contact.CustomDatetime5.Time, Valid: true}
                        }</span>

                        // Custom JSON fields
                        <span class="cov8" title="1">if !contact.CustomJSON1.IsNull </span><span class="cov0" title="0">{
                                customJSON1SQL, err = json.Marshal(contact.CustomJSON1.Data)
                                if err != nil </span><span class="cov0" title="0">{
                                        return fmt.Errorf("failed to marshal CustomJSON1: %w", err)
                                }</span>
                        }
                        <span class="cov8" title="1">if !contact.CustomJSON2.IsNull </span><span class="cov0" title="0">{
                                customJSON2SQL, err = json.Marshal(contact.CustomJSON2.Data)
                                if err != nil </span><span class="cov0" title="0">{
                                        return fmt.Errorf("failed to marshal CustomJSON2: %w", err)
                                }</span>
                        }
                        <span class="cov8" title="1">if !contact.CustomJSON3.IsNull </span><span class="cov0" title="0">{
                                customJSON3SQL, err = json.Marshal(contact.CustomJSON3.Data)
                                if err != nil </span><span class="cov0" title="0">{
                                        return fmt.Errorf("failed to marshal CustomJSON3: %w", err)
                                }</span>
                        }
                        <span class="cov8" title="1">if !contact.CustomJSON4.IsNull </span><span class="cov0" title="0">{
                                customJSON4SQL, err = json.Marshal(contact.CustomJSON4.Data)
                                if err != nil </span><span class="cov0" title="0">{
                                        return fmt.Errorf("failed to marshal CustomJSON4: %w", err)
                                }</span>
                        }
                        <span class="cov8" title="1">if !contact.CustomJSON5.IsNull </span><span class="cov0" title="0">{
                                customJSON5SQL, err = json.Marshal(contact.CustomJSON5.Data)
                                if err != nil </span><span class="cov0" title="0">{
                                        return fmt.Errorf("failed to marshal CustomJSON5: %w", err)
                                }</span>
                        }

                        <span class="cov8" title="1">_, err := stmt.ExecContext(ctx,
                                contact.Email,
                                contact.ExternalID,
                                contact.Timezone,
                                contact.Language,
                                firstNameSQL,
                                lastNameSQL,
                                phoneSQL,
                                addressLine1SQL,
                                addressLine2SQL,
                                countrySQL,
                                postcodeSQL,
                                stateSQL,
                                jobTitleSQL,
                                lifetimeValueSQL,
                                ordersCountSQL,
                                lastOrderAtSQL,
                                customString1SQL,
                                customString2SQL,
                                customString3SQL,
                                customString4SQL,
                                customString5SQL,
                                customNumber1SQL,
                                customNumber2SQL,
                                customNumber3SQL,
                                customNumber4SQL,
                                customNumber5SQL,
                                customDatetime1SQL,
                                customDatetime2SQL,
                                customDatetime3SQL,
                                customDatetime4SQL,
                                customDatetime5SQL,
                                customJSON1SQL,
                                customJSON2SQL,
                                customJSON3SQL,
                                customJSON4SQL,
                                customJSON5SQL,
                                contact.CreatedAt,
                                contact.UpdatedAt,
                        )
                        if err != nil </span><span class="cov8" title="1">{
                                return fmt.Errorf("failed to execute statement for contact %s: %w", contact.Email, err)
                        }</span>
                }
        }

        // Commit the transaction
        <span class="cov8" title="1">if err := tx.Commit(); err != nil </span><span class="cov8" title="1">{
                return fmt.Errorf("failed to commit transaction: %w", err)
        }</span>

        <span class="cov8" title="1">return nil</span>
}

func (r *contactRepository) UpsertContact(ctx context.Context, workspaceID string, contact *domain.Contact) (bool, error) <span class="cov8" title="1">{

        // Get the workspace database connection
        workspaceDB, err := r.workspaceRepo.GetConnection(ctx, workspaceID)
        if err != nil </span><span class="cov0" title="0">{
                return false, fmt.Errorf("failed to get workspace connection: %w", err)
        }</span>

        // Check if contact exists first
        <span class="cov8" title="1">_, err = r.GetContactByEmail(ctx, contact.Email, workspaceID)
        isNew := err != nil &amp;&amp; err.Error() == (&amp;domain.ErrContactNotFound{Message: "contact not found"}).Error()

        // If there was an error other than "not found", return it
        if err != nil &amp;&amp; !isNew </span><span class="cov8" title="1">{
                return false, fmt.Errorf("failed to check if contact exists: %w", err)
        }</span>

        <span class="cov8" title="1">query := `
                INSERT INTO contacts (
                        email, external_id, timezone, language,
                        first_name, last_name, phone, address_line_1, address_line_2,
                        country, postcode, state, job_title,
                        lifetime_value, orders_count, last_order_at,
                        custom_string_1, custom_string_2, custom_string_3, custom_string_4, custom_string_5,
                        custom_number_1, custom_number_2, custom_number_3, custom_number_4, custom_number_5,
                        custom_datetime_1, custom_datetime_2, custom_datetime_3, custom_datetime_4, custom_datetime_5,
                        custom_json_1, custom_json_2, custom_json_3, custom_json_4, custom_json_5,
                        created_at, updated_at
                )
                VALUES (
                        $1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11, $12, $13, $14, $15, $16,
                        $17, $18, $19, $20, $21, $22, $23, $24, $25, $26, $27, $28, $29, $30, $31, $32,
                        $33, $34, $35, $36, $37, $38
                )
                ON CONFLICT (email) DO UPDATE SET
                        external_id = EXCLUDED.external_id,
                        timezone = EXCLUDED.timezone,
                        first_name = EXCLUDED.first_name,
                        last_name = EXCLUDED.last_name,
                        phone = EXCLUDED.phone,
                        address_line_1 = EXCLUDED.address_line_1,
                        address_line_2 = EXCLUDED.address_line_2,
                        country = EXCLUDED.country,
                        postcode = EXCLUDED.postcode,
                        state = EXCLUDED.state,
                        job_title = EXCLUDED.job_title,
                        lifetime_value = EXCLUDED.lifetime_value,
                        orders_count = EXCLUDED.orders_count,
                        last_order_at = EXCLUDED.last_order_at,
                        custom_string_1 = EXCLUDED.custom_string_1,
                        custom_string_2 = EXCLUDED.custom_string_2,
                        custom_string_3 = EXCLUDED.custom_string_3,
                        custom_string_4 = EXCLUDED.custom_string_4,
                        custom_string_5 = EXCLUDED.custom_string_5,
                        custom_number_1 = EXCLUDED.custom_number_1,
                        custom_number_2 = EXCLUDED.custom_number_2,
                        custom_number_3 = EXCLUDED.custom_number_3,
                        custom_number_4 = EXCLUDED.custom_number_4,
                        custom_number_5 = EXCLUDED.custom_number_5,
                        custom_datetime_1 = EXCLUDED.custom_datetime_1,
                        custom_datetime_2 = EXCLUDED.custom_datetime_2,
                        custom_datetime_3 = EXCLUDED.custom_datetime_3,
                        custom_datetime_4 = EXCLUDED.custom_datetime_4,
                        custom_datetime_5 = EXCLUDED.custom_datetime_5,
                        custom_json_1 = EXCLUDED.custom_json_1,
                        custom_json_2 = EXCLUDED.custom_json_2,
                        custom_json_3 = EXCLUDED.custom_json_3,
                        custom_json_4 = EXCLUDED.custom_json_4,
                        custom_json_5 = EXCLUDED.custom_json_5,
                        updated_at = EXCLUDED.updated_at
        `

        // Convert domain nullable types to SQL nullable types
        var firstNameSQL, lastNameSQL, phoneSQL, addressLine1SQL, addressLine2SQL sql.NullString
        var countrySQL, postcodeSQL, stateSQL, jobTitleSQL sql.NullString
        var customString1SQL, customString2SQL, customString3SQL, customString4SQL, customString5SQL sql.NullString
        var lifetimeValueSQL, ordersCountSQL sql.NullFloat64
        var customNumber1SQL, customNumber2SQL, customNumber3SQL, customNumber4SQL, customNumber5SQL sql.NullFloat64
        var lastOrderAtSQL, customDatetime1SQL, customDatetime2SQL, customDatetime3SQL, customDatetime4SQL, customDatetime5SQL sql.NullTime
        var customJSON1SQL, customJSON2SQL, customJSON3SQL, customJSON4SQL, customJSON5SQL []byte

        // String fields
        if !contact.FirstName.IsNull </span><span class="cov8" title="1">{
                firstNameSQL = sql.NullString{String: contact.FirstName.String, Valid: true}
        }</span>
        <span class="cov8" title="1">if !contact.LastName.IsNull </span><span class="cov8" title="1">{
                lastNameSQL = sql.NullString{String: contact.LastName.String, Valid: true}
        }</span>
        <span class="cov8" title="1">if !contact.Phone.IsNull </span><span class="cov8" title="1">{
                phoneSQL = sql.NullString{String: contact.Phone.String, Valid: true}
        }</span>
        <span class="cov8" title="1">if !contact.AddressLine1.IsNull </span><span class="cov8" title="1">{
                addressLine1SQL = sql.NullString{String: contact.AddressLine1.String, Valid: true}
        }</span>
        <span class="cov8" title="1">if !contact.AddressLine2.IsNull </span><span class="cov8" title="1">{
                addressLine2SQL = sql.NullString{String: contact.AddressLine2.String, Valid: true}
        }</span>
        <span class="cov8" title="1">if !contact.Country.IsNull </span><span class="cov8" title="1">{
                countrySQL = sql.NullString{String: contact.Country.String, Valid: true}
        }</span>
        <span class="cov8" title="1">if !contact.Postcode.IsNull </span><span class="cov8" title="1">{
                postcodeSQL = sql.NullString{String: contact.Postcode.String, Valid: true}
        }</span>
        <span class="cov8" title="1">if !contact.State.IsNull </span><span class="cov8" title="1">{
                stateSQL = sql.NullString{String: contact.State.String, Valid: true}
        }</span>
        <span class="cov8" title="1">if !contact.JobTitle.IsNull </span><span class="cov8" title="1">{
                jobTitleSQL = sql.NullString{String: contact.JobTitle.String, Valid: true}
        }</span>

        // Custom string fields
        <span class="cov8" title="1">if !contact.CustomString1.IsNull </span><span class="cov8" title="1">{
                customString1SQL = sql.NullString{String: contact.CustomString1.String, Valid: true}
        }</span>
        <span class="cov8" title="1">if !contact.CustomString2.IsNull </span><span class="cov8" title="1">{
                customString2SQL = sql.NullString{String: contact.CustomString2.String, Valid: true}
        }</span>
        <span class="cov8" title="1">if !contact.CustomString3.IsNull </span><span class="cov8" title="1">{
                customString3SQL = sql.NullString{String: contact.CustomString3.String, Valid: true}
        }</span>
        <span class="cov8" title="1">if !contact.CustomString4.IsNull </span><span class="cov8" title="1">{
                customString4SQL = sql.NullString{String: contact.CustomString4.String, Valid: true}
        }</span>
        <span class="cov8" title="1">if !contact.CustomString5.IsNull </span><span class="cov8" title="1">{
                customString5SQL = sql.NullString{String: contact.CustomString5.String, Valid: true}
        }</span>

        // Number fields
        <span class="cov8" title="1">if !contact.LifetimeValue.IsNull </span><span class="cov8" title="1">{
                lifetimeValueSQL = sql.NullFloat64{Float64: contact.LifetimeValue.Float64, Valid: true}
        }</span>
        <span class="cov8" title="1">if !contact.OrdersCount.IsNull </span><span class="cov8" title="1">{
                ordersCountSQL = sql.NullFloat64{Float64: contact.OrdersCount.Float64, Valid: true}
        }</span>

        // Custom number fields
        <span class="cov8" title="1">if !contact.CustomNumber1.IsNull </span><span class="cov8" title="1">{
                customNumber1SQL = sql.NullFloat64{Float64: contact.CustomNumber1.Float64, Valid: true}
        }</span>
        <span class="cov8" title="1">if !contact.CustomNumber2.IsNull </span><span class="cov8" title="1">{
                customNumber2SQL = sql.NullFloat64{Float64: contact.CustomNumber2.Float64, Valid: true}
        }</span>
        <span class="cov8" title="1">if !contact.CustomNumber3.IsNull </span><span class="cov8" title="1">{
                customNumber3SQL = sql.NullFloat64{Float64: contact.CustomNumber3.Float64, Valid: true}
        }</span>
        <span class="cov8" title="1">if !contact.CustomNumber4.IsNull </span><span class="cov8" title="1">{
                customNumber4SQL = sql.NullFloat64{Float64: contact.CustomNumber4.Float64, Valid: true}
        }</span>
        <span class="cov8" title="1">if !contact.CustomNumber5.IsNull </span><span class="cov8" title="1">{
                customNumber5SQL = sql.NullFloat64{Float64: contact.CustomNumber5.Float64, Valid: true}
        }</span>

        // Datetime fields
        <span class="cov8" title="1">if !contact.LastOrderAt.IsNull </span><span class="cov8" title="1">{
                lastOrderAtSQL = sql.NullTime{Time: contact.LastOrderAt.Time, Valid: true}
        }</span>

        // Custom datetime fields
        <span class="cov8" title="1">if !contact.CustomDatetime1.IsNull </span><span class="cov8" title="1">{
                customDatetime1SQL = sql.NullTime{Time: contact.CustomDatetime1.Time, Valid: true}
        }</span>
        <span class="cov8" title="1">if !contact.CustomDatetime2.IsNull </span><span class="cov8" title="1">{
                customDatetime2SQL = sql.NullTime{Time: contact.CustomDatetime2.Time, Valid: true}
        }</span>
        <span class="cov8" title="1">if !contact.CustomDatetime3.IsNull </span><span class="cov8" title="1">{
                customDatetime3SQL = sql.NullTime{Time: contact.CustomDatetime3.Time, Valid: true}
        }</span>
        <span class="cov8" title="1">if !contact.CustomDatetime4.IsNull </span><span class="cov8" title="1">{
                customDatetime4SQL = sql.NullTime{Time: contact.CustomDatetime4.Time, Valid: true}
        }</span>
        <span class="cov8" title="1">if !contact.CustomDatetime5.IsNull </span><span class="cov8" title="1">{
                customDatetime5SQL = sql.NullTime{Time: contact.CustomDatetime5.Time, Valid: true}
        }</span>

        // Custom JSON fields
        <span class="cov8" title="1">if !contact.CustomJSON1.IsNull </span><span class="cov8" title="1">{
                customJSON1SQL, err = json.Marshal(contact.CustomJSON1.Data)
                if err != nil </span><span class="cov8" title="1">{
                        return false, fmt.Errorf("failed to marshal CustomJSON1: %w", err)
                }</span>
        }
        <span class="cov8" title="1">if !contact.CustomJSON2.IsNull </span><span class="cov8" title="1">{
                customJSON2SQL, err = json.Marshal(contact.CustomJSON2.Data)
                if err != nil </span><span class="cov0" title="0">{
                        return false, fmt.Errorf("failed to marshal CustomJSON2: %w", err)
                }</span>
        }
        <span class="cov8" title="1">if !contact.CustomJSON3.IsNull </span><span class="cov8" title="1">{
                customJSON3SQL, err = json.Marshal(contact.CustomJSON3.Data)
                if err != nil </span><span class="cov0" title="0">{
                        return false, fmt.Errorf("failed to marshal CustomJSON3: %w", err)
                }</span>
        }
        <span class="cov8" title="1">if !contact.CustomJSON4.IsNull </span><span class="cov8" title="1">{
                customJSON4SQL, err = json.Marshal(contact.CustomJSON4.Data)
                if err != nil </span><span class="cov0" title="0">{
                        return false, fmt.Errorf("failed to marshal CustomJSON4: %w", err)
                }</span>
        }
        <span class="cov8" title="1">if !contact.CustomJSON5.IsNull </span><span class="cov8" title="1">{
                customJSON5SQL, err = json.Marshal(contact.CustomJSON5.Data)
                if err != nil </span><span class="cov0" title="0">{
                        return false, fmt.Errorf("failed to marshal CustomJSON5: %w", err)
                }</span>
        }

        // Convert domain nullable types to SQL nullable types
        <span class="cov8" title="1">var externalIDSQL, timezoneSQL sql.NullString
        if !contact.ExternalID.IsNull </span><span class="cov8" title="1">{
                externalIDSQL = sql.NullString{String: contact.ExternalID.String, Valid: true}
        }</span>
        <span class="cov8" title="1">if !contact.Timezone.IsNull </span><span class="cov8" title="1">{
                timezoneSQL = sql.NullString{String: contact.Timezone.String, Valid: true}
        }</span>

        <span class="cov8" title="1">_, err = workspaceDB.ExecContext(ctx, query,
                contact.Email,
                externalIDSQL,
                timezoneSQL,
                contact.Language,
                firstNameSQL,
                lastNameSQL,
                phoneSQL,
                addressLine1SQL,
                addressLine2SQL,
                countrySQL,
                postcodeSQL,
                stateSQL,
                jobTitleSQL,
                lifetimeValueSQL,
                ordersCountSQL,
                lastOrderAtSQL,
                customString1SQL,
                customString2SQL,
                customString3SQL,
                customString4SQL,
                customString5SQL,
                customNumber1SQL,
                customNumber2SQL,
                customNumber3SQL,
                customNumber4SQL,
                customNumber5SQL,
                customDatetime1SQL,
                customDatetime2SQL,
                customDatetime3SQL,
                customDatetime4SQL,
                customDatetime5SQL,
                customJSON1SQL,
                customJSON2SQL,
                customJSON3SQL,
                customJSON4SQL,
                customJSON5SQL,
                contact.CreatedAt,
                contact.UpdatedAt,
        )

        if err != nil </span><span class="cov8" title="1">{
                return false, fmt.Errorf("failed to upsert contact: %w", err)
        }</span>

        <span class="cov8" title="1">return isNew, nil</span>
}
</pre>
		
		<pre class="file" id="file3" style="display: none">package repository

import (
        "context"
        "database/sql"
        "fmt"
        "time"

        "github.com/Notifuse/notifuse/internal/domain"
)

type listRepository struct {
        db            *sql.DB
        workspaceRepo domain.WorkspaceRepository
}

// NewListRepository creates a new PostgreSQL list repository
func NewListRepository(workspaceRepo domain.WorkspaceRepository) domain.ListRepository <span class="cov8" title="1">{
        return &amp;listRepository{
                workspaceRepo: workspaceRepo,
        }
}</span>

func (r *listRepository) CreateList(ctx context.Context, workspaceID string, list *domain.List) error <span class="cov8" title="1">{

        // Get the workspace database connection
        workspaceDB, err := r.workspaceRepo.GetConnection(ctx, workspaceID)
        if err != nil </span><span class="cov0" title="0">{
                return fmt.Errorf("failed to get workspace connection: %w", err)
        }</span>

        <span class="cov8" title="1">now := time.Now().UTC()
        list.CreatedAt = now
        list.UpdatedAt = now

        query := `
                INSERT INTO lists (id, name, type, is_double_optin, is_public, description, created_at, updated_at)
                VALUES ($1, $2, $3, $4, $5, $6, $7, $8)
        `
        _, err = workspaceDB.ExecContext(ctx, query,
                list.ID,
                list.Name,
                list.Type,
                list.IsDoubleOptin,
                list.IsPublic,
                list.Description,
                list.CreatedAt,
                list.UpdatedAt,
        )
        if err != nil </span><span class="cov8" title="1">{
                return fmt.Errorf("failed to create list: %w", err)
        }</span>
        <span class="cov8" title="1">return nil</span>
}

func (r *listRepository) GetListByID(ctx context.Context, workspaceID string, id string) (*domain.List, error) <span class="cov8" title="1">{
        // Get the workspace database connection
        workspaceDB, err := r.workspaceRepo.GetConnection(ctx, workspaceID)
        if err != nil </span><span class="cov0" title="0">{
                return nil, fmt.Errorf("failed to get workspace connection: %w", err)
        }</span>

        <span class="cov8" title="1">query := `
                SELECT id, name, type, is_double_optin, is_public, description, created_at, updated_at
                FROM lists
                WHERE id = $1
        `

        row := workspaceDB.QueryRowContext(ctx, query, id)
        list, err := domain.ScanList(row)

        if err == sql.ErrNoRows </span><span class="cov8" title="1">{
                return nil, &amp;domain.ErrListNotFound{Message: "list not found"}
        }</span>
        <span class="cov8" title="1">if err != nil </span><span class="cov8" title="1">{
                return nil, fmt.Errorf("failed to get list: %w", err)
        }</span>

        <span class="cov8" title="1">return list, nil</span>
}

func (r *listRepository) GetLists(ctx context.Context, workspaceID string) ([]*domain.List, error) <span class="cov8" title="1">{

        // Get the workspace database connection
        workspaceDB, err := r.workspaceRepo.GetConnection(ctx, workspaceID)
        if err != nil </span><span class="cov0" title="0">{
                return nil, fmt.Errorf("failed to get workspace connection: %w", err)
        }</span>

        <span class="cov8" title="1">query := `
                SELECT id, name, type, is_double_optin, is_public, description, created_at, updated_at
                FROM lists
                ORDER BY created_at DESC
        `

        rows, err := workspaceDB.QueryContext(ctx, query)
        if err != nil </span><span class="cov8" title="1">{
                return nil, fmt.Errorf("failed to get lists: %w", err)
        }</span>
        <span class="cov8" title="1">defer rows.Close()

        var lists []*domain.List
        for rows.Next() </span><span class="cov8" title="1">{
                list, err := domain.ScanList(rows)
                if err != nil </span><span class="cov0" title="0">{
                        return nil, fmt.Errorf("failed to scan list: %w", err)
                }</span>
                <span class="cov8" title="1">lists = append(lists, list)</span>
        }

        <span class="cov8" title="1">if err := rows.Err(); err != nil </span><span class="cov0" title="0">{
                return nil, fmt.Errorf("error iterating list rows: %w", err)
        }</span>

        <span class="cov8" title="1">return lists, nil</span>
}

func (r *listRepository) UpdateList(ctx context.Context, workspaceID string, list *domain.List) error <span class="cov8" title="1">{
        // Get the workspace database connection
        workspaceDB, err := r.workspaceRepo.GetConnection(ctx, workspaceID)
        if err != nil </span><span class="cov0" title="0">{
                return fmt.Errorf("failed to get workspace connection: %w", err)
        }</span>

        <span class="cov8" title="1">list.UpdatedAt = time.Now().UTC()

        query := `
                UPDATE lists
                SET name = $1, type = $2, is_double_optin = $3, is_public = $4, description = $5, updated_at = $6
                WHERE id = $7
        `

        result, err := workspaceDB.ExecContext(ctx, query,
                list.Name,
                list.Type,
                list.IsDoubleOptin,
                list.IsPublic,
                list.Description,
                list.UpdatedAt,
                list.ID,
        )

        if err != nil </span><span class="cov8" title="1">{
                return fmt.Errorf("failed to update list: %w", err)
        }</span>

        <span class="cov8" title="1">rows, err := result.RowsAffected()
        if err != nil </span><span class="cov0" title="0">{
                return fmt.Errorf("failed to get affected rows: %w", err)
        }</span>

        <span class="cov8" title="1">if rows == 0 </span><span class="cov8" title="1">{
                return &amp;domain.ErrListNotFound{Message: "list not found"}
        }</span>

        <span class="cov8" title="1">return nil</span>
}

func (r *listRepository) DeleteList(ctx context.Context, workspaceID string, id string) error <span class="cov8" title="1">{

        // Get the workspace database connection
        workspaceDB, err := r.workspaceRepo.GetConnection(ctx, workspaceID)
        if err != nil </span><span class="cov0" title="0">{
                return fmt.Errorf("failed to get workspace connection: %w", err)
        }</span>

        <span class="cov8" title="1">query := `DELETE FROM lists WHERE id = $1`

        result, err := workspaceDB.ExecContext(ctx, query, id)
        if err != nil </span><span class="cov8" title="1">{
                return fmt.Errorf("failed to delete list: %w", err)
        }</span>

        <span class="cov8" title="1">rows, err := result.RowsAffected()
        if err != nil </span><span class="cov0" title="0">{
                return fmt.Errorf("failed to get affected rows: %w", err)
        }</span>

        <span class="cov8" title="1">if rows == 0 </span><span class="cov8" title="1">{
                return &amp;domain.ErrListNotFound{Message: "list not found"}
        }</span>

        <span class="cov8" title="1">return nil</span>
}
</pre>
		
		<pre class="file" id="file4" style="display: none">package testutil

import (
        "database/sql"
        "testing"

        "github.com/DATA-DOG/go-sqlmock"
        "github.com/stretchr/testify/require"
)

// SetupMockDB creates a mock database connection for testing
func SetupMockDB(t *testing.T) (*sql.DB, sqlmock.Sqlmock, func()) <span class="cov8" title="1">{
        db, mock, err := sqlmock.New(sqlmock.QueryMatcherOption(sqlmock.QueryMatcherRegexp))
        require.NoError(t, err, "Failed to create mock database")

        cleanup := func() </span><span class="cov8" title="1">{
                db.Close()
        }</span>

        <span class="cov8" title="1">return db, mock, cleanup</span>
}
</pre>
		
		<pre class="file" id="file5" style="display: none">package testutil

import (
        "context"
        "database/sql"
        "fmt"

        "github.com/Notifuse/notifuse/internal/domain"
)

// MockWorkspaceRepository is a mock implementation of domain.WorkspaceRepository
type MockWorkspaceRepository struct {
        DB           *sql.DB
        WorkspaceDBs map[string]*sql.DB
}

// NewMockWorkspaceRepository creates a new mock workspace repository
func NewMockWorkspaceRepository(db *sql.DB) *MockWorkspaceRepository <span class="cov8" title="1">{
        return &amp;MockWorkspaceRepository{
                DB:           db,
                WorkspaceDBs: make(map[string]*sql.DB),
        }
}</span>

// AddWorkspaceDB adds a workspace database to the mock
func (m *MockWorkspaceRepository) AddWorkspaceDB(workspaceID string, db *sql.DB) <span class="cov8" title="1">{
        m.WorkspaceDBs[workspaceID] = db
}</span>

func (m *MockWorkspaceRepository) GetConnection(ctx context.Context, workspaceID string) (*sql.DB, error) <span class="cov8" title="1">{
        // Return the workspaceDB if it exists
        if db, ok := m.WorkspaceDBs[workspaceID]; ok </span><span class="cov8" title="1">{
                return db, nil
        }</span>

        // Return error for non-existent workspaces
        <span class="cov8" title="1">return nil, fmt.Errorf("failed to get workspace connection")</span>
}

// Implement other required methods with empty implementations
func (m *MockWorkspaceRepository) Create(ctx context.Context, workspace *domain.Workspace) error <span class="cov0" title="0">{
        return nil
}</span>

func (m *MockWorkspaceRepository) GetByID(ctx context.Context, id string) (*domain.Workspace, error) <span class="cov0" title="0">{
        return nil, nil
}</span>

func (m *MockWorkspaceRepository) List(ctx context.Context) ([]*domain.Workspace, error) <span class="cov0" title="0">{
        return nil, nil
}</span>

func (m *MockWorkspaceRepository) Update(ctx context.Context, workspace *domain.Workspace) error <span class="cov0" title="0">{
        return nil
}</span>

func (m *MockWorkspaceRepository) Delete(ctx context.Context, id string) error <span class="cov0" title="0">{
        return nil
}</span>

func (m *MockWorkspaceRepository) CreateDatabase(ctx context.Context, workspaceID string) error <span class="cov0" title="0">{
        return nil
}</span>

func (m *MockWorkspaceRepository) DeleteDatabase(ctx context.Context, workspaceID string) error <span class="cov0" title="0">{
        return nil
}</span>

func (m *MockWorkspaceRepository) AddUserToWorkspace(ctx context.Context, userWorkspace *domain.UserWorkspace) error <span class="cov0" title="0">{
        return nil
}</span>

func (m *MockWorkspaceRepository) RemoveUserFromWorkspace(ctx context.Context, userID string, workspaceID string) error <span class="cov0" title="0">{
        return nil
}</span>

func (m *MockWorkspaceRepository) GetUserWorkspaces(ctx context.Context, userID string) ([]*domain.UserWorkspace, error) <span class="cov0" title="0">{
        return nil, nil
}</span>

func (m *MockWorkspaceRepository) GetUserWorkspace(ctx context.Context, userID string, workspaceID string) (*domain.UserWorkspace, error) <span class="cov0" title="0">{
        return nil, nil
}</span>

func (m *MockWorkspaceRepository) CreateInvitation(ctx context.Context, invitation *domain.WorkspaceInvitation) error <span class="cov0" title="0">{
        return nil
}</span>

func (m *MockWorkspaceRepository) GetInvitationByID(ctx context.Context, id string) (*domain.WorkspaceInvitation, error) <span class="cov0" title="0">{
        return nil, nil
}</span>

func (m *MockWorkspaceRepository) GetInvitationByEmail(ctx context.Context, workspaceID, email string) (*domain.WorkspaceInvitation, error) <span class="cov0" title="0">{
        return nil, nil
}</span>

func (m *MockWorkspaceRepository) IsUserWorkspaceMember(ctx context.Context, userID, workspaceID string) (bool, error) <span class="cov0" title="0">{
        return false, nil
}</span>

func (m *MockWorkspaceRepository) GetWorkspaceUsersWithEmail(ctx context.Context, workspaceID string) ([]*domain.UserWorkspaceWithEmail, error) <span class="cov0" title="0">{
        return nil, nil
}</span>
</pre>
		
		<pre class="file" id="file6" style="display: none">package repository

import (
        "context"
        "database/sql"
        "fmt"
        "time"

        "github.com/google/uuid"

        "github.com/Notifuse/notifuse/internal/domain"
)

type userRepository struct {
        db *sql.DB
}

// NewUserRepository creates a new PostgreSQL user repository
func NewUserRepository(db *sql.DB) domain.UserRepository <span class="cov8" title="1">{
        return &amp;userRepository{db: db}
}</span>

func (r *userRepository) CreateUser(ctx context.Context, user *domain.User) error <span class="cov8" title="1">{
        if user.ID == "" </span><span class="cov0" title="0">{
                user.ID = uuid.New().String()
        }</span>
        <span class="cov8" title="1">now := time.Now().UTC()
        user.CreatedAt = now
        user.UpdatedAt = now

        query := `
                INSERT INTO users (id, email, name, created_at, updated_at)
                VALUES ($1, $2, $3, $4, $5)
        `
        _, err := r.db.ExecContext(ctx, query,
                user.ID,
                user.Email,
                user.Name,
                user.CreatedAt,
                user.UpdatedAt,
        )
        if err != nil </span><span class="cov8" title="1">{
                return fmt.Errorf("failed to create user: %w", err)
        }</span>
        <span class="cov8" title="1">return nil</span>
}

func (r *userRepository) GetUserByEmail(ctx context.Context, email string) (*domain.User, error) <span class="cov8" title="1">{
        var user domain.User
        query := `
                SELECT id, email, name, created_at, updated_at
                FROM users
                WHERE email = $1
        `
        err := r.db.QueryRowContext(ctx, query, email).Scan(
                &amp;user.ID,
                &amp;user.Email,
                &amp;user.Name,
                &amp;user.CreatedAt,
                &amp;user.UpdatedAt,
        )
        if err == sql.ErrNoRows </span><span class="cov8" title="1">{
                return nil, &amp;domain.ErrUserNotFound{Message: "user not found"}
        }</span>
        <span class="cov8" title="1">if err != nil </span><span class="cov8" title="1">{
                return nil, fmt.Errorf("failed to get user: %w", err)
        }</span>
        <span class="cov8" title="1">return &amp;user, nil</span>
}

func (r *userRepository) GetUserByID(ctx context.Context, id string) (*domain.User, error) <span class="cov8" title="1">{
        var user domain.User
        query := `
                SELECT id, email, name, created_at, updated_at
                FROM users
                WHERE id = $1
        `
        err := r.db.QueryRowContext(ctx, query, id).Scan(
                &amp;user.ID,
                &amp;user.Email,
                &amp;user.Name,
                &amp;user.CreatedAt,
                &amp;user.UpdatedAt,
        )
        if err == sql.ErrNoRows </span><span class="cov8" title="1">{
                return nil, &amp;domain.ErrUserNotFound{Message: "user not found"}
        }</span>
        <span class="cov8" title="1">if err != nil </span><span class="cov0" title="0">{
                return nil, fmt.Errorf("failed to get user: %w", err)
        }</span>
        <span class="cov8" title="1">return &amp;user, nil</span>
}

func (r *userRepository) CreateSession(ctx context.Context, session *domain.Session) error <span class="cov8" title="1">{
        if session.ID == "" </span><span class="cov0" title="0">{
                session.ID = uuid.New().String()
        }</span>
        <span class="cov8" title="1">session.CreatedAt = time.Now().UTC()
        session.ExpiresAt = session.ExpiresAt.UTC()
        if !session.MagicCodeExpires.IsZero() </span><span class="cov8" title="1">{
                session.MagicCodeExpires = session.MagicCodeExpires.UTC()
        }</span>

        <span class="cov8" title="1">query := `
                INSERT INTO user_sessions (
                        id, user_id, expires_at, created_at, 
                        magic_code, magic_code_expires_at
                )
                VALUES ($1, $2, $3, $4, $5, $6)
        `
        _, err := r.db.ExecContext(ctx, query,
                session.ID,
                session.UserID,
                session.ExpiresAt,
                session.CreatedAt,
                session.MagicCode,
                session.MagicCodeExpires,
        )
        if err != nil </span><span class="cov0" title="0">{
                return fmt.Errorf("failed to create session: %w", err)
        }</span>
        <span class="cov8" title="1">return nil</span>
}

func (r *userRepository) GetSessionByID(ctx context.Context, id string) (*domain.Session, error) <span class="cov8" title="1">{
        var session domain.Session
        query := `
                SELECT id, user_id, expires_at, created_at, 
                        magic_code, magic_code_expires_at
                FROM user_sessions
                WHERE id = $1
        `
        err := r.db.QueryRowContext(ctx, query, id).Scan(
                &amp;session.ID,
                &amp;session.UserID,
                &amp;session.ExpiresAt,
                &amp;session.CreatedAt,
                &amp;session.MagicCode,
                &amp;session.MagicCodeExpires,
        )
        if err == sql.ErrNoRows </span><span class="cov8" title="1">{
                return nil, &amp;domain.ErrSessionNotFound{Message: "session not found"}
        }</span>
        <span class="cov8" title="1">if err != nil </span><span class="cov0" title="0">{
                return nil, fmt.Errorf("failed to get session: %w", err)
        }</span>
        <span class="cov8" title="1">return &amp;session, nil</span>
}

func (r *userRepository) DeleteSession(ctx context.Context, id string) error <span class="cov8" title="1">{
        query := `DELETE FROM user_sessions WHERE id = $1`
        result, err := r.db.ExecContext(ctx, query, id)
        if err != nil </span><span class="cov0" title="0">{
                return fmt.Errorf("failed to delete session: %w", err)
        }</span>
        <span class="cov8" title="1">rows, err := result.RowsAffected()
        if err != nil </span><span class="cov0" title="0">{
                return fmt.Errorf("failed to get rows affected: %w", err)
        }</span>
        <span class="cov8" title="1">if rows == 0 </span><span class="cov8" title="1">{
                return &amp;domain.ErrSessionNotFound{Message: "session not found"}
        }</span>
        <span class="cov8" title="1">return nil</span>
}

func (r *userRepository) GetSessionsByUserID(ctx context.Context, userID string) ([]*domain.Session, error) <span class="cov8" title="1">{
        query := `
                SELECT id, user_id, expires_at, created_at, magic_code, magic_code_expires_at
                FROM user_sessions
                WHERE user_id = $1
                ORDER BY created_at DESC
        `
        rows, err := r.db.QueryContext(ctx, query, userID)
        if err != nil </span><span class="cov0" title="0">{
                return nil, fmt.Errorf("failed to get sessions: %w", err)
        }</span>
        <span class="cov8" title="1">defer rows.Close()

        var sessions []*domain.Session
        for rows.Next() </span><span class="cov8" title="1">{
                var session domain.Session
                err := rows.Scan(
                        &amp;session.ID,
                        &amp;session.UserID,
                        &amp;session.ExpiresAt,
                        &amp;session.CreatedAt,
                        &amp;session.MagicCode,
                        &amp;session.MagicCodeExpires,
                )
                if err != nil </span><span class="cov0" title="0">{
                        return nil, fmt.Errorf("failed to scan session: %w", err)
                }</span>
                <span class="cov8" title="1">sessions = append(sessions, &amp;session)</span>
        }
        <span class="cov8" title="1">return sessions, rows.Err()</span>
}

func (r *userRepository) UpdateSession(ctx context.Context, session *domain.Session) error <span class="cov8" title="1">{
        query := `
                UPDATE user_sessions
                SET expires_at = $1,
                        magic_code = $2,
                        magic_code_expires_at = $3
                WHERE id = $4
        `
        result, err := r.db.ExecContext(ctx, query,
                session.ExpiresAt,
                session.MagicCode,
                session.MagicCodeExpires,
                session.ID,
        )
        if err != nil </span><span class="cov0" title="0">{
                return fmt.Errorf("failed to update session: %w", err)
        }</span>

        <span class="cov8" title="1">rows, err := result.RowsAffected()
        if err != nil </span><span class="cov0" title="0">{
                return fmt.Errorf("failed to get rows affected: %w", err)
        }</span>
        <span class="cov8" title="1">if rows == 0 </span><span class="cov8" title="1">{
                return &amp;domain.ErrSessionNotFound{Message: "session not found"}
        }</span>
        <span class="cov8" title="1">return nil</span>
}
</pre>
		
		<pre class="file" id="file7" style="display: none">package repository

import (
        "context"
        "database/sql"
        "encoding/json"
        "fmt"
        "strings"
        "sync"
        "time"

        "github.com/Notifuse/notifuse/config"
        "github.com/Notifuse/notifuse/internal/database"
        "github.com/Notifuse/notifuse/internal/domain"
)

type workspaceRepository struct {
        systemDB *sql.DB
        dbConfig *config.DatabaseConfig

        // Connection pool for workspace databases
        connections sync.Map
}

// NewWorkspaceRepository creates a new PostgreSQL workspace repository
func NewWorkspaceRepository(systemDB *sql.DB, dbConfig *config.DatabaseConfig) domain.WorkspaceRepository <span class="cov8" title="1">{
        return &amp;workspaceRepository{
                systemDB: systemDB,
                dbConfig: dbConfig,
        }
}</span>

// checkWorkspaceIDExists checks if a workspace with the given ID already exists
func (r *workspaceRepository) checkWorkspaceIDExists(ctx context.Context, id string) (bool, error) <span class="cov8" title="1">{
        var exists bool
        query := `SELECT EXISTS(SELECT 1 FROM workspaces WHERE id = $1)`
        err := r.systemDB.QueryRowContext(ctx, query, id).Scan(&amp;exists)
        if err != nil </span><span class="cov8" title="1">{
                return false, fmt.Errorf("failed to check workspace ID existence: %w", err)
        }</span>
        <span class="cov8" title="1">return exists, nil</span>
}

func (r *workspaceRepository) Create(ctx context.Context, workspace *domain.Workspace) error <span class="cov0" title="0">{
        if workspace.ID == "" </span><span class="cov0" title="0">{
                return fmt.Errorf("workspace ID is required")
        }</span>

        // Validate workspace before creating
        <span class="cov0" title="0">if err := workspace.Validate(); err != nil </span><span class="cov0" title="0">{
                return err
        }</span>

        // Check if workspace ID already exists
        <span class="cov0" title="0">exists, err := r.checkWorkspaceIDExists(ctx, workspace.ID)
        if err != nil </span><span class="cov0" title="0">{
                return err
        }</span>
        <span class="cov0" title="0">if exists </span><span class="cov0" title="0">{
                return fmt.Errorf("workspace with ID %s already exists", workspace.ID)
        }</span>

        <span class="cov0" title="0">now := time.Now()
        workspace.CreatedAt = now
        workspace.UpdatedAt = now

        // Marshal settings to JSON
        settings, err := json.Marshal(workspace.Settings)
        if err != nil </span><span class="cov0" title="0">{
                return fmt.Errorf("failed to marshal settings: %w", err)
        }</span>

        <span class="cov0" title="0">query := `
                INSERT INTO workspaces (id, name, settings, created_at, updated_at)
                VALUES ($1, $2, $3, $4, $5)
        `
        _, err = r.systemDB.ExecContext(ctx, query,
                workspace.ID,
                workspace.Name,
                settings,
                workspace.CreatedAt,
                workspace.UpdatedAt,
        )
        if err != nil </span><span class="cov0" title="0">{
                return fmt.Errorf("failed to create workspace: %w", err)
        }</span>

        // Create the workspace database
        <span class="cov0" title="0">return r.CreateDatabase(ctx, workspace.ID)</span>
}

func (r *workspaceRepository) GetByID(ctx context.Context, id string) (*domain.Workspace, error) <span class="cov8" title="1">{
        query := `
                SELECT id, name, settings, created_at, updated_at
                FROM workspaces
                WHERE id = $1
        `
        workspace, err := domain.ScanWorkspace(r.systemDB.QueryRowContext(ctx, query, id))
        if err == sql.ErrNoRows </span><span class="cov0" title="0">{
                return nil, fmt.Errorf("workspace not found")
        }</span>
        <span class="cov8" title="1">if err != nil </span><span class="cov8" title="1">{
                return nil, fmt.Errorf("failed to get workspace: %w", err)
        }</span>
        <span class="cov8" title="1">return workspace, nil</span>
}

func (r *workspaceRepository) List(ctx context.Context) ([]*domain.Workspace, error) <span class="cov8" title="1">{
        query := `
                SELECT id, name, settings, created_at, updated_at
                FROM workspaces
                ORDER BY created_at DESC
        `
        rows, err := r.systemDB.QueryContext(ctx, query)
        if err != nil </span><span class="cov0" title="0">{
                return nil, fmt.Errorf("failed to list workspaces: %w", err)
        }</span>
        <span class="cov8" title="1">defer rows.Close()

        var workspaces []*domain.Workspace
        for rows.Next() </span><span class="cov8" title="1">{
                workspace, err := domain.ScanWorkspace(rows)
                if err != nil </span><span class="cov0" title="0">{
                        return nil, fmt.Errorf("failed to scan workspace: %w", err)
                }</span>
                <span class="cov8" title="1">workspaces = append(workspaces, workspace)</span>
        }
        <span class="cov8" title="1">return workspaces, rows.Err()</span>
}

func (r *workspaceRepository) Update(ctx context.Context, workspace *domain.Workspace) error <span class="cov8" title="1">{
        workspace.UpdatedAt = time.Now()

        // Validate workspace before updating
        if err := workspace.Validate(); err != nil </span><span class="cov8" title="1">{
                return err
        }</span>

        // Marshal settings to JSON
        <span class="cov8" title="1">settings, err := json.Marshal(workspace.Settings)
        if err != nil </span><span class="cov0" title="0">{
                return fmt.Errorf("failed to marshal settings: %w", err)
        }</span>

        <span class="cov8" title="1">query := `
                UPDATE workspaces
                SET name = $1, settings = $2, updated_at = $3
                WHERE id = $4
        `
        result, err := r.systemDB.ExecContext(ctx, query,
                workspace.Name,
                settings,
                workspace.UpdatedAt,
                workspace.ID,
        )
        if err != nil </span><span class="cov8" title="1">{
                return fmt.Errorf("failed to update workspace: %w", err)
        }</span>
        <span class="cov8" title="1">rows, err := result.RowsAffected()
        if err != nil </span><span class="cov8" title="1">{
                return fmt.Errorf("failed to get affected rows: %w", err)
        }</span>
        <span class="cov8" title="1">if rows == 0 </span><span class="cov8" title="1">{
                return fmt.Errorf("workspace not found")
        }</span>
        <span class="cov8" title="1">return nil</span>
}

func (r *workspaceRepository) Delete(ctx context.Context, id string) error <span class="cov8" title="1">{
        // Delete the workspace database first
        if err := r.DeleteDatabase(ctx, id); err != nil </span><span class="cov8" title="1">{
                return err
        }</span>

        // Delete all user_workspaces entries for this workspace
        <span class="cov8" title="1">deleteUserWorkspacesQuery := `DELETE FROM user_workspaces WHERE workspace_id = $1`
        if _, err := r.systemDB.ExecContext(ctx, deleteUserWorkspacesQuery, id); err != nil </span><span class="cov8" title="1">{
                return fmt.Errorf("failed to delete user workspaces: %w", err)
        }</span>

        // Delete all workspace invitations for this workspace
        <span class="cov8" title="1">deleteInvitationsQuery := `DELETE FROM workspace_invitations WHERE workspace_id = $1`
        if _, err := r.systemDB.ExecContext(ctx, deleteInvitationsQuery, id); err != nil </span><span class="cov8" title="1">{
                return fmt.Errorf("failed to delete workspace invitations: %w", err)
        }</span>

        // Then delete the workspace record
        <span class="cov8" title="1">query := `DELETE FROM workspaces WHERE id = $1`
        result, err := r.systemDB.ExecContext(ctx, query, id)
        if err != nil </span><span class="cov8" title="1">{
                return fmt.Errorf("failed to delete workspace: %w", err)
        }</span>
        <span class="cov8" title="1">rows, err := result.RowsAffected()
        if err != nil </span><span class="cov0" title="0">{
                return fmt.Errorf("failed to get affected rows: %w", err)
        }</span>
        <span class="cov8" title="1">if rows == 0 </span><span class="cov8" title="1">{
                return fmt.Errorf("workspace not found")
        }</span>
        <span class="cov8" title="1">return nil</span>
}

func (r *workspaceRepository) GetConnection(ctx context.Context, workspaceID string) (*sql.DB, error) <span class="cov8" title="1">{
        // Check if we already have a connection
        if conn, ok := r.connections.Load(workspaceID); ok </span><span class="cov8" title="1">{
                db := conn.(*sql.DB)
                // Test the connection
                if err := db.PingContext(ctx); err == nil </span><span class="cov8" title="1">{
                        return db, nil
                }</span>
                // If ping fails, remove the connection and create a new one
                <span class="cov0" title="0">r.connections.Delete(workspaceID)</span>
        }

        // Create a new connection
        <span class="cov8" title="1">db, err := database.ConnectToWorkspace(r.dbConfig, workspaceID)
        if err != nil </span><span class="cov8" title="1">{
                return nil, err
        }</span>

        // Store the connection
        <span class="cov0" title="0">r.connections.Store(workspaceID, db)
        return db, nil</span>
}

func (r *workspaceRepository) CreateDatabase(ctx context.Context, workspaceID string) error <span class="cov0" title="0">{
        // Use the utility function to ensure the database exists and initialize it
        if err := database.EnsureWorkspaceDatabaseExists(r.dbConfig, workspaceID); err != nil </span><span class="cov0" title="0">{
                return fmt.Errorf("failed to create and initialize workspace database: %w", err)
        }</span>
        <span class="cov0" title="0">return nil</span>
}

func (r *workspaceRepository) DeleteDatabase(ctx context.Context, workspaceID string) error <span class="cov8" title="1">{
        // Remove the connection from the pool if it exists
        r.connections.Delete(workspaceID)

        // Replace hyphens with underscores for PostgreSQL compatibility
        safeID := strings.ReplaceAll(workspaceID, "-", "_")
        dbName := fmt.Sprintf("%s_ws_%s", r.dbConfig.Prefix, safeID)

        // Drop the database
        _, err := r.systemDB.ExecContext(ctx, fmt.Sprintf("DROP DATABASE IF EXISTS %s", dbName))
        if err != nil </span><span class="cov8" title="1">{
                return fmt.Errorf("failed to delete workspace database: %w", err)
        }</span>

        <span class="cov8" title="1">return nil</span>
}

func (r *workspaceRepository) AddUserToWorkspace(ctx context.Context, userWorkspace *domain.UserWorkspace) error <span class="cov8" title="1">{
        query := `
                INSERT INTO user_workspaces (user_id, workspace_id, role, created_at, updated_at)
                VALUES ($1, $2, $3, $4, $5)
                ON CONFLICT (user_id, workspace_id) DO UPDATE
                SET role = $3, updated_at = $5
        `
        _, err := r.systemDB.ExecContext(ctx, query,
                userWorkspace.UserID,
                userWorkspace.WorkspaceID,
                userWorkspace.Role,
                userWorkspace.CreatedAt,
                userWorkspace.UpdatedAt,
        )
        if err != nil </span><span class="cov8" title="1">{
                return fmt.Errorf("failed to add user to workspace: %w", err)
        }</span>
        <span class="cov8" title="1">return nil</span>
}

func (r *workspaceRepository) RemoveUserFromWorkspace(ctx context.Context, userID string, workspaceID string) error <span class="cov8" title="1">{
        query := `DELETE FROM user_workspaces WHERE user_id = $1 AND workspace_id = $2`
        result, err := r.systemDB.ExecContext(ctx, query, userID, workspaceID)
        if err != nil </span><span class="cov8" title="1">{
                return fmt.Errorf("failed to remove user from workspace: %w", err)
        }</span>
        <span class="cov8" title="1">rows, err := result.RowsAffected()
        if err != nil </span><span class="cov8" title="1">{
                return fmt.Errorf("failed to get affected rows: %w", err)
        }</span>
        <span class="cov8" title="1">if rows == 0 </span><span class="cov8" title="1">{
                return fmt.Errorf("user is not a member of the workspace")
        }</span>
        <span class="cov8" title="1">return nil</span>
}

func (r *workspaceRepository) GetUserWorkspaces(ctx context.Context, userID string) ([]*domain.UserWorkspace, error) <span class="cov8" title="1">{
        query := `
                SELECT user_id, workspace_id, role, created_at, updated_at
                FROM user_workspaces
                WHERE user_id = $1
        `
        rows, err := r.systemDB.QueryContext(ctx, query, userID)
        if err != nil </span><span class="cov8" title="1">{
                return nil, fmt.Errorf("failed to get user workspaces: %w", err)
        }</span>
        <span class="cov8" title="1">defer rows.Close()

        var userWorkspaces []*domain.UserWorkspace
        for rows.Next() </span><span class="cov8" title="1">{
                var uw domain.UserWorkspace
                err := rows.Scan(&amp;uw.UserID, &amp;uw.WorkspaceID, &amp;uw.Role, &amp;uw.CreatedAt, &amp;uw.UpdatedAt)
                if err != nil </span><span class="cov0" title="0">{
                        return nil, fmt.Errorf("failed to scan user workspace: %w", err)
                }</span>
                <span class="cov8" title="1">userWorkspaces = append(userWorkspaces, &amp;uw)</span>
        }
        <span class="cov8" title="1">return userWorkspaces, rows.Err()</span>
}

func (r *workspaceRepository) GetUserWorkspace(ctx context.Context, userID string, workspaceID string) (*domain.UserWorkspace, error) <span class="cov8" title="1">{
        query := `
                SELECT user_id, workspace_id, role, created_at, updated_at
                FROM user_workspaces
                WHERE user_id = $1 AND workspace_id = $2
        `
        var uw domain.UserWorkspace
        err := r.systemDB.QueryRowContext(ctx, query, userID, workspaceID).Scan(
                &amp;uw.UserID, &amp;uw.WorkspaceID, &amp;uw.Role, &amp;uw.CreatedAt, &amp;uw.UpdatedAt,
        )
        if err == sql.ErrNoRows </span><span class="cov0" title="0">{
                return nil, fmt.Errorf("user is not a member of the workspace")
        }</span>
        <span class="cov8" title="1">if err != nil </span><span class="cov8" title="1">{
                return nil, fmt.Errorf("failed to get user workspace: %w", err)
        }</span>
        <span class="cov8" title="1">return &amp;uw, nil</span>
}

// CreateInvitation creates a new workspace invitation
func (r *workspaceRepository) CreateInvitation(ctx context.Context, invitation *domain.WorkspaceInvitation) error <span class="cov8" title="1">{
        query := `
                INSERT INTO workspace_invitations (id, workspace_id, inviter_id, email, expires_at, created_at, updated_at)
                VALUES ($1, $2, $3, $4, $5, $6, $7)
        `
        _, err := r.systemDB.ExecContext(
                ctx,
                query,
                invitation.ID,
                invitation.WorkspaceID,
                invitation.InviterID,
                invitation.Email,
                invitation.ExpiresAt,
                invitation.CreatedAt,
                invitation.UpdatedAt,
        )
        if err != nil </span><span class="cov8" title="1">{
                return err
        }</span>
        <span class="cov8" title="1">return nil</span>
}

// GetInvitationByID retrieves a workspace invitation by its ID
func (r *workspaceRepository) GetInvitationByID(ctx context.Context, id string) (*domain.WorkspaceInvitation, error) <span class="cov8" title="1">{
        query := `
                SELECT id, workspace_id, inviter_id, email, expires_at, created_at, updated_at
                FROM workspace_invitations
                WHERE id = $1
        `
        var invitation domain.WorkspaceInvitation
        err := r.systemDB.QueryRowContext(ctx, query, id).Scan(
                &amp;invitation.ID,
                &amp;invitation.WorkspaceID,
                &amp;invitation.InviterID,
                &amp;invitation.Email,
                &amp;invitation.ExpiresAt,
                &amp;invitation.CreatedAt,
                &amp;invitation.UpdatedAt,
        )
        if err != nil </span><span class="cov8" title="1">{
                if err == sql.ErrNoRows </span><span class="cov8" title="1">{
                        return nil, fmt.Errorf("invitation not found")
                }</span>
                <span class="cov8" title="1">return nil, err</span>
        }
        <span class="cov8" title="1">return &amp;invitation, nil</span>
}

// GetInvitationByEmail retrieves a workspace invitation by workspace ID and email
func (r *workspaceRepository) GetInvitationByEmail(ctx context.Context, workspaceID, email string) (*domain.WorkspaceInvitation, error) <span class="cov8" title="1">{
        query := `
                SELECT id, workspace_id, inviter_id, email, expires_at, created_at, updated_at
                FROM workspace_invitations
                WHERE workspace_id = $1 AND email = $2
                ORDER BY created_at DESC
                LIMIT 1
        `
        var invitation domain.WorkspaceInvitation
        err := r.systemDB.QueryRowContext(ctx, query, workspaceID, email).Scan(
                &amp;invitation.ID,
                &amp;invitation.WorkspaceID,
                &amp;invitation.InviterID,
                &amp;invitation.Email,
                &amp;invitation.ExpiresAt,
                &amp;invitation.CreatedAt,
                &amp;invitation.UpdatedAt,
        )
        if err != nil </span><span class="cov8" title="1">{
                if err == sql.ErrNoRows </span><span class="cov8" title="1">{
                        return nil, fmt.Errorf("invitation not found")
                }</span>
                <span class="cov8" title="1">return nil, err</span>
        }
        <span class="cov8" title="1">return &amp;invitation, nil</span>
}

// IsUserWorkspaceMember checks if a user is a member of a workspace
func (r *workspaceRepository) IsUserWorkspaceMember(ctx context.Context, userID, workspaceID string) (bool, error) <span class="cov8" title="1">{
        query := `
                SELECT COUNT(*)
                FROM user_workspaces
                WHERE user_id = $1 AND workspace_id = $2
        `
        var count int
        err := r.systemDB.QueryRowContext(ctx, query, userID, workspaceID).Scan(&amp;count)
        if err != nil </span><span class="cov8" title="1">{
                return false, err
        }</span>
        <span class="cov8" title="1">return count &gt; 0, nil</span>
}

// GetWorkspaceUsersWithEmail returns all users for a workspace including email information
func (r *workspaceRepository) GetWorkspaceUsersWithEmail(ctx context.Context, workspaceID string) ([]*domain.UserWorkspaceWithEmail, error) <span class="cov8" title="1">{
        query := `
                SELECT uw.user_id, uw.workspace_id, uw.role, uw.created_at, uw.updated_at, u.email
                FROM user_workspaces uw
                JOIN users u ON uw.user_id = u.id
                WHERE uw.workspace_id = $1
        `
        rows, err := r.systemDB.QueryContext(ctx, query, workspaceID)
        if err != nil </span><span class="cov8" title="1">{
                return nil, fmt.Errorf("failed to get workspace users with email: %w", err)
        }</span>
        <span class="cov8" title="1">defer rows.Close()

        var userWorkspaces []*domain.UserWorkspaceWithEmail
        for rows.Next() </span><span class="cov8" title="1">{
                var uw domain.UserWorkspaceWithEmail
                err := rows.Scan(
                        &amp;uw.UserID,
                        &amp;uw.WorkspaceID,
                        &amp;uw.Role,
                        &amp;uw.CreatedAt,
                        &amp;uw.UpdatedAt,
                        &amp;uw.Email,
                )
                if err != nil </span><span class="cov8" title="1">{
                        return nil, fmt.Errorf("failed to scan user workspace with email: %w", err)
                }</span>
                <span class="cov8" title="1">userWorkspaces = append(userWorkspaces, &amp;uw)</span>
        }

        <span class="cov8" title="1">if err := rows.Err(); err != nil </span><span class="cov0" title="0">{
                return nil, fmt.Errorf("error iterating workspace users rows: %w", err)
        }</span>

        <span class="cov8" title="1">return userWorkspaces, nil</span>
}
</pre>
		
		</div>
	</body>
	<script>
	(function() {
		var files = document.getElementById('files');
		var visible;
		files.addEventListener('change', onChange, false);
		function select(part) {
			if (visible)
				visible.style.display = 'none';
			visible = document.getElementById(part);
			if (!visible)
				return;
			files.value = part;
			visible.style.display = 'block';
			location.hash = part;
		}
		function onChange() {
			select(files.value);
			window.scrollTo(0, 0);
		}
		if (location.hash != "") {
			select(location.hash.substr(1));
		}
		if (!visible) {
			select("file0");
		}
	})();
	</script>
</html>
